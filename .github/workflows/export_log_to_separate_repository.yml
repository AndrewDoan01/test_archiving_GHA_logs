name: Archive Logs to Separate Repo

on:
  workflow_run:
    workflows: ["*"]
    types: [completed]
  workflow_dispatch:

permissions:
  actions: read

jobs:
  archive-to-logs-repo:
    runs-on: ubuntu-latest

    steps:
      - name: (optional) Checkout main repo
        uses: actions/checkout@v4
        with:
          repository: AndrewDoan01/test_archiving_GHA_logs
          path: main-repo
          token: ${{ secrets.FOR_ARCHIVING_LOGS }}

      - name: Download workflow logs
        uses: actions/github-script@v7
        id: download
        with:
          github-token: ${{ secrets.FOR_ARCHIVING_LOGS }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const run = context.payload.workflow_run;
            const runId = run.id;

            console.log(`ðŸ“¥ Processing: ${run.name} #${run.run_number}`);

            const baseLogsDir = 'archived-logs';
            const rawName = run.name || `workflow-${runId}`;
            const safeWorkflowName = rawName.replace(/[^a-z0-9]/gi, '-').toLowerCase();
            const ts = new Date(run.created_at).toISOString().replace(/[:.]/g, '-');
            const runDir = path.join(baseLogsDir, `${safeWorkflowName}-${runId}-${ts}`);
            if (!fs.existsSync(runDir)) fs.mkdirSync(runDir, { recursive: true });

            try {
              const logs = await github.rest.actions.downloadWorkflowRunLogs({
                owner: 'AndrewDoan01',
                repo: 'test_archiving_GHA_logs',
                run_id: runId,
              });

              const filename = `${safeWorkflowName}-${runId}-${ts}.zip`;
              fs.writeFileSync(path.join(runDir, filename), Buffer.from(logs.data));

              const metadata = {
                source_repo: 'AndrewDoan01/test_archiving_GHA_logs',
                workflow: { name: run.name, id: run.workflow_id },
                run: { id: runId, number: run.run_number, status: run.conclusion, created_at: run.created_at, url: run.html_url },
                git: { branch: run.head_branch, commit: run.head_sha },
                actor: run.actor?.login,
                archived_at: new Date().toISOString(),
                size_bytes: logs.data.byteLength,
              };

              fs.writeFileSync(path.join(runDir, `${safeWorkflowName}-${runId}-metadata.json`), JSON.stringify(metadata, null, 2));

              const summaryLines = [
                'GitHub Actions Log Archive',
                '=========================',
                `Source: AndrewDoan01/test_archiving_GHA_logs`,
                `Workflow: ${run.name}`,
                `Run: #${run.run_number}`,
                `Status: ${run.conclusion}`,
                `Branch: ${run.head_branch}`,
                `Commit: ${run.head_sha}`,
                `Actor: ${run.actor?.login}`,
                `Date: ${run.created_at}`,
                '',
                `Log File: ${filename}`,
                `Size: ${(logs.data.byteLength / 1024 / 1024).toFixed(2)} MB`,
                `Archived: ${new Date().toISOString()}`,
                '',
                `View online: ${run.html_url}`,
              ];

              fs.writeFileSync(path.join(runDir, `${safeWorkflowName}-${runId}-summary.txt`), summaryLines.join('\n'));

              // expose outputs for next steps
              core.setOutput('run_dir', runDir);
              core.setOutput('archive_filename', filename);
              core.setOutput('archive_size_bytes', logs.data.byteLength);

              return { filename, runDir };

            } catch (error) {
              console.error(`âŒ Error: ${error.message}`);
              throw error;
            }

            - name: Create compressed archive
              id: compress
              env:
                RUN_DIR: ${{ steps.download.outputs.run_dir }}
              run: |
                  ARCHIVE_NAME="logs-run-${{ github.event.workflow_run.id }}.tar.gz"
                  # compress only the run-specific directory
                  tar -czf "${ARCHIVE_NAME}" -C "${RUN_DIR}" .
                  sha256sum "${ARCHIVE_NAME}" > "${ARCHIVE_NAME}.sha256"
                  echo "archive_name=${ARCHIVE_NAME}" >> $GITHUB_OUTPUT
                  SIZE=$(stat -c%s "${ARCHIVE_NAME}")
                  SIZE_MB=$(echo "scale=2; ${SIZE} / 1024 / 1024" | bc)
                  echo "archive_size_mb=${SIZE_MB}" >> $GITHUB_OUTPUT

      - name: Create release in logs repo
        uses: softprops/action-gh-release@v1
        with:
          repository: AndrewDoan01/mmtt_GHA_logs
          tag_name: logs-run-${{ github.event.workflow_run.id }}
          name: "ðŸ“‹ ${{ github.event.workflow_run.name }} #${{ github.event.workflow_run.run_number }}"
          files: |
            ${{ steps.compress.outputs.archive_name }}
            ${{ steps.compress.outputs.archive_name }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.FOR_ARCHIVING_LOGS }}
